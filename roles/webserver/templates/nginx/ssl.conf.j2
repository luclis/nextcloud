#SSL Configuration
{% if tls_certificate_type != 'selfsigned' %}
ssl_trusted_certificate {{ tls_certificate_ca }};
{% endif %}
ssl_dhparam {{ tls_dh_file }};
ssl_protocols TLSv1.3 TLSv1.2;
ssl_ciphers 'EECDH+CHACHA20:EECDH+AESGCM';
ssl_ecdh_curve X25519:secp384r1;
ssl_prefer_server_ciphers on;

{% if tls_certificate_type != 'selfsigned' %}
ssl_stapling on;
ssl_stapling_verify on;
{% endif %}
{% if tls_certificate_type = 'pkisigned' %}
#Parametre ocsp. Pas encore mis en place.
#resolver 127.0.0.1 80.67.169.12 valid=300s;
#resolver_timeout 5s;
{% endif %}

ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_session_tickets off;

#Upstream servers
#Serveur php par defaut.
upstream php-handler {
  server unix:{{ php_socket[ansible_distribution] }};
}
{% if install_onlyoffice %}
upstream onlyoffice-docker {
  server 127.0.0.1:{{ onlyoffice_ssl_port }}
}
{% endif %}

#Block Spam
limit_req_zone $binary_remote_addr zone=flood:20m rate=100r/s;
